<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/styles.css">
    <title>Manage Adoptions - Orphanage Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('../img/2304.q894.005.jpg') no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: #333;
        }

        .form-container, .record-list {
            margin: 20px;
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .form-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-container input[type="text"],
        .form-container input[type="date"],
        .form-container select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .form-container input[type="submit"] {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .form-container input[type="submit"]:hover {
            background-color: #218838;
        }

        .record-list table {
            width: 100%;
            border-collapse: collapse;
        }

        .record-list th,
        .record-list td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        .record-list th {
            background-color: #f4f4f4;
        }

        .edit-button,
        .delete-button {
            background-color: #ffc107;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .edit-button:hover {
            background-color: #e0a800;
        }

        .delete-button {
            background-color: #dc3545;
        }

        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <br/>
        <br/>

        <div class="form-container">
            <h2>Manage Adoptions</h2>
            <h3 id="form-title">Add Adoption Record</h3>
            <form id="adoption-form" onsubmit="return validateForm(event);">
                <input type="hidden" name="adoption_id" id="adoption_id" value="">
                <label for="child_id">Child:</label>
                <select name="child_id" id="child_id">
                    <option value="">Select Child</option>
                </select>

                <label for="adopter_name">Adopter Name:</label>
                <input type="text" id="adopter_name" name="adopter_name">

                <label for="adopter_contact">Adopter Contact:</label>
                <input type="text" id="adopter_contact" name="adopter_contact">

                <label for="adopter_nid">Adopter NID:</label>
                <input type="text" id="adopter_nid" name="adopter_nid">

                <label for="adoption_date">Adoption Date:</label>
                <input type="date" id="adoption_date" name="adoption_date">

                <input type="submit" value="Add Adoption Record">
            </form>
        </div>

        <div class="record-list">
            <h3>Existing Adoption Records</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Child Name</th>
                        <th>Adopter Name</th>
                        <th>Adopter Contact</th>
                        <th>Adopter NID</th>
                        <th>Adoption Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adoption-records">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://orphan-management-system.onrender.com';

        async function validateForm(event) {
            event.preventDefault();

            var childId = document.getElementById('child_id').value.trim();
            var adopterName = document.getElementById('adopter_name').value.trim();
            var adopterContact = document.getElementById('adopter_contact').value.trim();
            var adopterNid = document.getElementById('adopter_nid').value.trim();
            var adoptionDate = document.getElementById('adoption_date').value;

            if (childId === '') {
                alert('Child ID is required.');
                return false;
            }

            if (adopterName === '') {
                alert('Adopter Name is required.');
                return false;
            }

            if (adopterContact === '') {
                alert('Adopter Contact is required.');
                return false;
            }

            if (adopterNid === '') {
                alert('Adopter NID is required.');
                return false;
            }

            if (!/^\d{10}$|^\d{17}$/.test(adopterNid)) {
                alert('Adopter NID must be either 10 or 17 digits.');
                return false;
            }

            if (adoptionDate === '') {
                alert('Adoption Date is required.');
                return false;
            }

            const adoptionId = document.getElementById('adoption_id').value;
            const method = adoptionId ? 'PUT' : 'POST';
            const url = `${API_BASE_URL}/api/adoptions${adoptionId ? `/${adoptionId}` : ''}`;

            const adoptionData = {
                child_id: childId,
                adopter_name: adopterName,
                adopter_contact: adopterContact,
                adopter_nid: adopterNid,
                adoption_date: new Date(adoptionDate).toISOString()
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(adoptionData)
                });

                if (response.ok) {
                    alert('Adoption record submitted successfully!');
                    fetchAdoptionRecords();
                    resetForm();
                } else {
                    const errorData = await response.json();
                    console.error('Error submitting adoption record:', errorData);
                    alert(`Error: ${errorData.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error or server is down.');
            }

            return false;
        }

        async function fetchAdoptionRecords() {
    try {

        const response = await fetch(`${API_BASE_URL}/api/adoptions`);


        if (!response.ok) {

            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const adoptions = await response.json();
        const tableBody = document.getElementById('adoption-records');
        tableBody.innerHTML = '';

        adoptions.forEach(adoption => {
            const row = document.createElement('tr');


            row.innerHTML = `
                <td>${adoption._id}</td>
                <td>${adoption.child_id?.first_name || 'N/A'} ${adoption.child_id?.last_name || ''}</td>
                <td>${adoption.adopter_name}</td>
                <td>${adoption.adopter_contact}</td>
                <td>${adoption.adopter_nid}</td>
                <td>${new Date(adoption.adoption_date).toLocaleDateString()}</td>
                <td>
                    <button class="edit-button" onclick="editRecord('${adoption._id}')">Edit</button>
                    <button class="delete-button" onclick="deleteRecord('${adoption._id}')">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error('Error fetching adoption records:', error);
        alert('Failed to fetch adoption records.');
    }
}
        async function fetchChildren() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/children`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const children = await response.json();
                const childSelect = document.getElementById('child_id');

                children.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child._id;
                    option.textContent = `${child.first_name} ${child.last_name}`;
                    childSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching children:', error);
                alert('Failed to fetch children.');
            }
        }

        async function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this adoption record?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/adoptions/${id}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert('Record deleted successfully!');
                        fetchAdoptionRecords();
                    } else {
                        const errorData = await response.json();
                        console.error('Error deleting record:', errorData);
                        alert(`Error deleting record: ${errorData.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error deleting record:', error);
                    alert('Network error or server is down.');
                }
            }
        }

        async function editRecord(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/adoptions/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const adoption = await response.json();

                document.getElementById('form-title').innerText = 'Edit Adoption Record';
                document.getElementById('adoption_id').value = adoption._id;
                document.getElementById('child_id').value = adoption.child_id;
                document.getElementById('adopter_name').value = adoption.adopter_name;
                document.getElementById('adopter_contact').value = adoption.adopter_contact;
                document.getElementById('adopter_nid').value = adoption.adopter_nid;
                document.getElementById('adoption_date').value = new Date(adoption.adoption_date).toISOString().split('T')[0];
                document.getElementById('submit-button').value = 'Update Adoption Record';
            } catch (error) {
                console.error('Error fetching adoption for edit:', error);
                alert('Failed to fetch adoption for editing.');
            }
        }

        function resetForm() {
            document.getElementById('form-title').innerText = 'Add Adoption Record';
            document.getElementById('adoption_id').value = '';
            document.getElementById('child_id').value = '';
            document.getElementById('adopter_name').value = '';
            document.getElementById('adopter_contact').value = '';
            document.getElementById('adopter_nid').value = '';
            document.getElementById('adoption_date').value = '';
        }

        window.onload = () => {
            fetchAdoptionRecords();
            fetchChildren();
        };
    </script>
</body>
</html>