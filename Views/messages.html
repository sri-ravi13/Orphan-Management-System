<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    <title>Messages - Orphanage Management System</title>
    <style>

        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --danger-color: #e74c3c;
            --danger-dark: #c0392b;
            --warning-color: #f39c12;
            --light-gray: #f8f9fa;
            --medium-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
            --text-color: #34495e;
            --card-bg: #ffffff;
            --border-color: #dfe4ea;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.08);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: var(--light-gray);


            background: url('../img/subtle-background.png');
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }


        .header {
             background-color: #2c3e50;
             color: #ffffff;
             padding: 15px 0;
             text-align: center;
             box-shadow: var(--shadow-sm);
             position: sticky;
             top: 0;
             z-index: 1000;
        }
        .header h1 { margin: 0; font-weight: 600; font-size: 1.7em; }


        .main-container {
            max-width: 950px;
            margin: 35px auto;
            padding: 0 15px;
            flex-grow: 1;
        }


         .back-link {
             display: inline-block;
             margin-bottom: 20px;
             color: var(--primary-color);
             text-decoration: none;
             font-weight: 500;
             font-size: 0.95em;
         }
         .back-link i { margin-right: 5px; }
         .back-link:hover { color: var(--primary-dark); text-decoration: underline; }


        .message-section {
            background-color: var(--card-bg);
            margin-bottom: 35px;
            padding: 30px 35px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .message-section:last-child { margin-bottom: 0; }


        .section-title {
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 12px;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        h2.section-title {
            font-size: 1.8em; color: var(--text-color); text-align: center; justify-content: center;
        }
        h3.section-title {
            font-size: 1.4em; color: var(--text-color); margin-top: 0;
        }


        .message-form label {
            display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.95em;
        }
        .message-form select,
        .message-form textarea {
            width: 100%; padding: 12px 15px; margin-bottom: 18px;
            border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; font-size: 1rem;
            background-color: #fdfdfd;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .message-form select:disabled { background-color: var(--medium-gray); cursor: not-allowed; }
         .message-form textarea { resize: vertical; min-height: 120px; }
         .message-form select:focus,
         .message-form textarea:focus {
             border-color: var(--primary-color); outline: none;
             box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
         }
        .message-form .submit-btn {
             background-color: var(--primary-color); color: #fff; border: none; padding: 12px 28px;
             border-radius: 25px; cursor: pointer; font-size: 1.05rem; font-weight: 600;
             transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
             display: inline-flex; align-items: center; box-shadow: var(--shadow-sm);
         }
         .message-form .submit-btn i { margin-right: 8px; }
        .message-form .submit-btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .message-form .submit-btn:disabled { background-color: var(--dark-gray); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }


         .status-message {
             margin-top: 20px; padding: 12px 15px; border-radius: 6px; font-weight: 500; display: none; text-align: center; border: 1px solid transparent;
             font-size: 0.95em;
         }
         .status-message i { margin-right: 8px; }
         .status-message.success { background-color: #d1fae5; color: #065f46; border-color: #6ee7b7; display: block; }
         .status-message.error { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; display: block; }
         .status-message.loading { background-color: #e0f2fe; color: #075985; border-color: #7dd3fc; display: block; }
         .status-message.info { background-color: #e0f2fe; color: #075985; border-color: #7dd3fc; display: block; }



        .message-list-container {
             margin-top: 20px;
        }
        .message-list { max-height: 450px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;}
        .message-list table { width: 100%; border-collapse: collapse; }
        .message-list th,
        .message-list td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .message-list th {
             background-color: var(--medium-gray); color: var(--text-color); font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;
             position: sticky; top: 0; z-index: 1;
         }
        .message-list tbody tr:last-child td { border-bottom: none; }
        .message-list tbody tr:hover { background-color: #f1f8fd; }
        .message-list td.sender-col { font-weight: 600; color: var(--primary-dark); min-width: 120px; }
        .message-list td.date-col { font-size: 0.85em; color: var(--dark-gray); white-space: nowrap; text-align: right; min-width: 150px;}
        .message-list td.message-col { line-height: 1.5; }

        .table-message td { text-align: center; color: var(--dark-gray); padding: 40px 20px; font-style: italic; }
        .table-message.error td { color: var(--danger-color); font-weight: 500; font-style: normal; }
        .table-message .fa-spinner { margin-right: 8px; }


         .footer {
             width: 100%;
             background-color: #2c3e50;
             color: #bdc3c7;
             text-align: center;
             padding: 15px 0;
             margin-top: auto;
             font-size: 0.9em;
         }
         .footer a { color: #ecf0f1; text-decoration: none; }
         .footer a:hover { text-decoration: underline; }


         @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
         .fa-spin { animation: fa-spin 1s infinite linear; }

    </style>
</head>
<body>
    <header class="header">
        <h1>Orphanage Management System</h1>
    </header>

    <div class="main-container">

        
        

        <div class="message-section">
            
            <h2 class="section-title"><i class="fas fa-comments"></i>Messages</h2>

            
            <h3 class="section-title"><i class="fas fa-paper-plane"></i>Send a Message</h3>
            <form class="message-form" id="message-form"> 
                <label for="receiver_id">To:</label>
                <select name="receiver_id" id="receiver_id" required>
                    <option value="" disabled selected>-- Select User --</option>
                    
                </select>

                <label for="message_text">Message:</label>
                <textarea name="message_text" id="message_text" rows="5" required placeholder="Type your message here..."></textarea>

                <button type="submit" id="send-button" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
                 
                <div id="form-status" class="status-message"></div>
            </form>
        </div>

        <div class="message-section">
            <h3 class="section-title"><i class="fas fa-inbox"></i>Inbox</h3>
            <div class="message-list-container">
                <div class="message-list">
                    <table>
                        <thead>
                            <tr>
                                <th class="sender-col">From</th>
                                <th class="message-col">Message</th>
                                <th class="date-col">Sent At</th>
                            </tr>
                        </thead>
                        <tbody id="message-records">
                            
                             <tr class="table-message loading">
                                 <td colspan="3"><i class="fas fa-spinner fa-spin"></i> Loading messages...</td>
                             </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Â© 2024 Orphanage Management System --- Your Name or Organization
        
        
    </div>

    <script>
        const API_BASE_URL = 'https://orphan-management-system.onrender.com';
        const LOGGED_IN_USER_KEY = 'loggedInUser';
        let currentUserId = null;


        function getLoggedInUserId() {
            const storedUser = JSON.parse(localStorage.getItem(LOGGED_IN_USER_KEY) || '{}');
            currentUserId = storedUser.id || null;
            return currentUserId;
        }


        function getAuthHeaders() {
            const userId = currentUserId || getLoggedInUserId();
            if (!userId) {
                console.error("Cannot create auth headers: User ID is missing.");
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'X-User-ID': userId
            };
        }


        function displayStatus(elementId, message, type = 'info', autoHide = true) {
             const statusDiv = document.getElementById(elementId);
             if (!statusDiv) { console.warn(`Status element #${elementId} not found.`); return; }

             statusDiv.className = `status-message ${type}`;
             let iconClass = 'fas fa-info-circle';
             if (type === 'success') iconClass = 'fas fa-check-circle';
             if (type === 'error') iconClass = 'fas fa-exclamation-triangle';
             if (type === 'loading') iconClass = 'fas fa-spinner fa-spin';

             statusDiv.innerHTML = message ? `<i class="${iconClass}"></i> ${message}` : '';
             statusDiv.style.display = message ? 'block' : 'none';


             if (statusDiv.timeoutId) { clearTimeout(statusDiv.timeoutId); }

             if (autoHide && (type === 'success' || type === 'info')) {
                 statusDiv.timeoutId = setTimeout(() => {
                     if (statusDiv.classList.contains(type)) {
                         statusDiv.style.display = 'none';
                         statusDiv.innerHTML = '';
                         statusDiv.className = 'status-message';
                     }
                 }, 5000);
             } else {
                 statusDiv.timeoutId = null;
             }
         }


        async function fetchUsers() {
            const receiverSelect = document.getElementById('receiver_id');
            receiverSelect.disabled = true;
            receiverSelect.innerHTML = '<option value="" disabled selected>-- Loading Users... --</option>';

            const headers = getAuthHeaders();
            if (!headers) {
                 displayStatus('form-status', 'Cannot load users. Authentication failed.', 'error', false);
                 receiverSelect.innerHTML = '<option value="" disabled selected>-- Error Loading Users --</option>';
                 receiverSelect.disabled = false;
                 return;
             }

            try {
                const response = await fetch(`${API_BASE_URL}/api/messages/users`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    if (response.status === 401) throw new Error("Unauthorized. Please log in.");
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const users = await response.json();
                receiverSelect.innerHTML = '<option value="" disabled selected>-- Select User --</option>';

                if (users && users.length > 0) {
                     users.forEach(user => {

                         const option = document.createElement('option');
                         option.value = user._id;
                         option.textContent = user.username || user.name || user._id;
                         receiverSelect.appendChild(option);
                     });
                 } else {
                     receiverSelect.innerHTML = '<option value="" disabled selected>-- No users available --</option>';
                 }
                 receiverSelect.disabled = false;

            } catch (error) {
                console.error('Error fetching users:', error);
                receiverSelect.innerHTML = '<option value="" disabled selected>-- Error Loading Users --</option>';
                displayStatus('form-status', `Error loading users: ${error.message}`, 'error', false);
                receiverSelect.disabled = false;
            }
        }


        async function fetchMessages() {
             const messageRecords = document.getElementById('message-records');
             messageRecords.innerHTML = `<tr class="table-message loading"><td colspan="3"><i class="fas fa-spinner fa-spin"></i> Loading messages...</td></tr>`;

             const headers = getAuthHeaders();
             if (!headers) {
                 messageRecords.innerHTML = `<tr class="table-message error"><td colspan="3">Cannot load messages. User not identified. Please log in.</td></tr>`;
                 return;
             }

            try {
                const response = await fetch(`${API_BASE_URL}/api/messages`, {
                     method: 'GET',
                     headers: headers
                });

                if (!response.ok) {
                     if (response.status === 401) throw new Error("Unauthorized. Please log in.");
                     const errorData = await response.json().catch(() => ({}));
                     throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const messages = await response.json();
                 messageRecords.innerHTML = '';

                 if (!messages || messages.length === 0) {
                     messageRecords.innerHTML = `<tr class="table-message"><td colspan="3">Your inbox is empty.</td></tr>`;
                     return;
                 }


                 messages.sort((a, b) => new Date(b.sent_at || 0) - new Date(a.sent_at || 0));

                messages.forEach(message => {
                    const row = messageRecords.insertRow();
                    const senderName = (message.sender_id && message.sender_id.username) ? message.sender_id.username : (message.sender_id && message.sender_id.name) ? message.sender_id.name : 'Unknown Sender';

                    const cellFrom = row.insertCell();
                    cellFrom.className = 'sender-col';
                    cellFrom.textContent = senderName;

                    const cellMessage = row.insertCell();
                    cellMessage.className = 'message-col';
                    cellMessage.textContent = message.message_text || '';

                    const cellDate = row.insertCell();
                    cellDate.className = 'date-col';
                    cellDate.textContent = message.sent_at ? new Date(message.sent_at).toLocaleString() : 'N/A';
                });
            } catch (error) {
                console.error('Error fetching messages:', error);
                messageRecords.innerHTML = `<tr class="table-message error"><td colspan="3">Failed to load messages: ${error.message}</td></tr>`;
            }
        }


        async function handleMessageSubmit(event) {
            event.preventDefault();

            const receiverId = document.getElementById('receiver_id').value.trim();
            const messageText = document.getElementById('message_text').value.trim();
            const sendButton = document.getElementById('send-button');


            displayStatus('form-status', '', 'info', false);

            if (receiverId === '') {
                 displayStatus('form-status', 'Please select a recipient.', 'error', false); return;
            }
            if (messageText === '') {
                 displayStatus('form-status', 'Please enter a message.', 'error', false); return;
            }

             const messageData = { receiver_id: receiverId, message_text: messageText };

             displayStatus('form-status', 'Sending...', 'loading', false);
             sendButton.disabled = true;

             const headers = getAuthHeaders();
             if (!headers) {
                  displayStatus('form-status', 'Authentication error. Cannot send message.', 'error', false);
                  sendButton.disabled = false;
                  return;
             }

            try {
                const response = await fetch(`${API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(messageData)
                });

                const result = await response.json();

                if (response.ok) {
                    displayStatus('form-status', 'Message sent successfully!', 'success', true);
                    document.getElementById('message-form').reset();


                } else {
                     throw new Error(result.message || `HTTP error! Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                 displayStatus('form-status', `Error: ${error.message}`, 'error', false);
            } finally {
                 sendButton.disabled = false;
            }
        }


        window.addEventListener('DOMContentLoaded', () => {
            if (getLoggedInUserId()) {
                fetchUsers();
                fetchMessages();

                document.getElementById('message-form').addEventListener('submit', handleMessageSubmit);
            } else {

                 displayStatus('form-status', 'Please log in to use the messaging system.', 'error', false);
                 document.getElementById('receiver_id').innerHTML = '<option value="" disabled selected>Please log in</option>';
                 document.getElementById('receiver_id').disabled = true;
                 document.getElementById('message-records').innerHTML = `<tr class="table-message error"><td colspan="3">Please log in to view messages.</td></tr>`;
                 document.getElementById('send-button').disabled = true;
                 document.getElementById('message_text').disabled = true;
            }
        });

    </script>
</body>
</html>