<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>Educational Management - Orphanage Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --primary-dark: #2980b9; --danger-color: #e74c3c;
            --warning-color: #f39c12; --light-gray: #f8f9fa; --medium-gray: #ecf0f1;
            --dark-gray: #7f8c8d; --text-color: #34495e; --card-bg: rgba(255, 255, 255, 0.97);
            --border-color: #dfe6e9; --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: #f4f7f6; color: var(--text-color); line-height: 1.6;
            position: relative; min-height: 100vh; padding-top: 80px;
             display: flex; flex-direction: column;
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: url('../img/29012291_7524843.jpg') no-repeat center center fixed;
            background-size: cover; z-index: -1;
            background-color: rgba(255, 255, 255, 0.25);
            background-blend-mode: overlay;
        }

        .page-header {
            width: 100%; background: linear-gradient(90deg, #34495e, #2c3e50); color: #ffffff;
            padding: 15px 40px; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            position: fixed; top: 0; left: 0; z-index: 1001;
            display: flex; justify-content: space-between; align-items: center;
        }
        .page-header h1 { margin: 0; font-weight: 600; font-size: 1.6em; flex-grow: 1; text-align: center; }
        .back-link {
             color: #ffffff; text-decoration: none; font-size: 0.95em; font-weight: 500;
             padding: 8px 15px; border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 5px;
             transition: background-color 0.3s ease, border-color 0.3s ease;
         }
        .back-link:hover { background-color: rgba(255, 255, 255, 0.1); border-color: #fff; }
        .back-link i { margin-right: 6px; }


        .main-container { max-width: 1200px; width: 95%; margin: 30px auto; padding: 0 15px; flex-grow: 1; }


        .card {
            margin-bottom: 30px; padding: 35px; background-color: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 10px; box-shadow: var(--shadow-md);
        }
        .card h2 {
            text-align: left; color: var(--text-color); margin-bottom: 25px;
            font-weight: 600; font-size: 1.5em; border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px; margin-top: 0;
        }
        .card h3 {
            margin-top: 0; margin-bottom: 30px; color: #555; font-weight: 500; font-size: 1.3em;
        }


        .form-container label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.95em; }
        .form-container input[type="text"], .form-container textarea, .form-container select {
            width: 100%; padding: 12px 15px; margin-bottom: 20px; border: 1px solid #bdc3c7;
            border-radius: 5px; font-family: inherit; font-size: 1rem; background-color: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-container textarea { resize: vertical; min-height: 100px; }
        .form-container input:focus, .form-container textarea:focus, .form-container select:focus {
            border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        .form-container input[type="submit"] {
            background-color: var(--primary-color); color: #fff; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .form-container input[type="submit"]:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .form-container input[type="submit"]:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }


        .record-list .table-responsive { overflow-x: auto; width: 100%; margin-top: 10px; }
        .record-list table { width: 100%; min-width: 900px; border-collapse: collapse; }
        .record-list th, .record-list td { border-bottom: 1px solid var(--border-color); padding: 14px 16px; text-align: left; vertical-align: middle; font-size: 0.95em; }
        .record-list th { background-color: var(--medium-gray); color: var(--text-color); font-weight: 600; text-transform: uppercase; font-size: 0.8em; letter-spacing: 0.5px; border-top: 1px solid var(--border-color); border-bottom-width: 2px; }
        .record-list tbody tr:nth-child(even) { background-color: #fdfdfd; }
        .record-list tbody tr:hover { background-color: #e9f5ff; }
        .record-list td textarea { width: 100%; min-height: 40px; max-height: 100px; overflow-y: auto; border: none; background: transparent; resize: none; padding: 0; margin: 0; font-family: inherit; font-size: inherit; line-height: inherit; color: inherit; display: block; }
        .record-list .actions-col { white-space: nowrap; width: 1%; }


        .action-buttons { display: flex; gap: 8px; }
        .edit-button, .delete-button {
            color: #fff; border: none; padding: 7px 14px; border-radius: 4px; cursor: pointer;
            font-size: 0.85em; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .edit-button { background-color: var(--warning-color); }
        .edit-button:hover { background-color: #d35400; transform: translateY(-1px); }
        .delete-button { background-color: var(--danger-color); }
        .delete-button:hover { background-color: #c0392b; transform: translateY(-1px); }


        @media (max-width: 768px) {
            .page-header { padding: 15px 20px; }
            .page-header h1 { font-size: 1.4em; }
            .back-link { font-size: 0.9em; padding: 6px 10px; }
            .main-container { width: 100%; padding: 0 10px; }
            .card { padding: 20px; }
            .card h2 { font-size: 1.3em; } .card h3 { font-size: 1.1em; }
            .form-container input, .form-container textarea, .form-container select, .form-container input[type="submit"] { padding: 10px 12px; font-size: 0.95rem; }


             .record-list .table-responsive { overflow-x: visible; }
             .record-list table, .record-list thead, .record-list tbody, .record-list th, .record-list td, .record-list tr { display: block; }
             .record-list thead tr { position: absolute; top: -9999px; left: -9999px; }
             .record-list tr { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; background-color: #fff !important; padding: 10px;}
             .record-list td { border: none; border-bottom: 1px dashed #eee; position: relative; padding-left: 45%; text-align: right; min-height: 35px; display: flex; align-items: center; justify-content: flex-end; padding-top: 8px; padding-bottom: 8px; }
             .record-list td:before { content: attr(data-label); position: absolute; left: 10px; width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #555; font-size: 0.85em; }
             .record-list td[data-label*="Summary"], .record-list td[data-label*="Activities"], .record-list td[data-label*="Attendance"] { min-height: 50px; align-items: flex-start; }
             .record-list td[data-label*="Summary"] textarea, .record-list td[data-label*="Activities"] textarea, .record-list td[data-label*="Attendance"] textarea { text-align: right; padding: 0; }
             .record-list td:last-child { border-bottom: 0; }
             .action-buttons { justify-content: flex-end; padding-top: 5px; width: 100%; }
             .record-list td[data-label="Actions"] { padding-left: 10px; }
             .record-list td[data-label="Actions"]:before { content: ""; }
        }


        .footer { width: 100%; background-color: #34495e; color: #ecf0f1; text-align: center; padding: 15px 0; margin-top: auto; font-size: 0.9em; }
    </style>
</head>
<body>
    
    <header class="page-header">
        <a href="#" id="back-dashboard-link" class="back-link"><i class="fas fa-arrow-left"></i> Dashboard</a>
        <h1>Educational Management</h1>
        <div style="width: 80px;"></div> 
    </header>

    <div class="main-container">

        
        <div class="card form-container">
            <h3 id="form-title">Add New Educational Record</h3>
            <form id="record-form" onsubmit="return validateForm(event);">
                <input type="hidden" id="record_id" name="record_id" value="">

                <label for="child_id">Child:</label>
                <select name="child_id" id="child_id" required>
                    <option value="" disabled selected>Loading children...</option>
                    
                </select>

                <label for="school_name">School Name:</label>
                <input type="text" id="school_name" name="school_name" placeholder="Enter school name" required>

                <label for="grade">Grade/Level:</label>
                <input type="text" id="grade" name="grade" placeholder="e.g., Grade 5, Year 10, Level 3" required>

                <label for="class_section">Class/Section:</label>
                <input type="text" id="class_section" name="class" placeholder="e.g., 5B, 10A, Section C" required>

                <label for="performance">Academic Performance:</label>
                <textarea id="performance" name="performance" rows="4" placeholder="Describe academic progress, strengths, areas for improvement..." required></textarea>

                <label for="attendance">Attendance Record:</label>
                <textarea id="attendance" name="attendance" rows="2" placeholder="e.g., 95% attendance, Notes on absences..." required></textarea>

                <label for="extracurricular_activities">Extracurricular Activities:</label>
                <textarea id="extracurricular_activities" name="extracurricular_activities" rows="3" placeholder="List activities, participation level, achievements..." required></textarea>

                <input type="submit" id="submit-button" value="Add Educational Record">
            </form>
        </div>

        
        <div class="card record-list">
            <h3 id="record-list-title">Existing Educational Records</h3> 
             <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Child Name</th>
                            <th>School</th>
                            <th>Grade</th>
                            <th>Class</th>
                            <th>Performance Summary</th>
                            <th>Activities</th>
                            <th>Attendance</th>
                            <th class="actions-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="record-table-body">
                         <tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--dark-gray);">Loading records... <i class="fas fa-spinner fa-spin"></i></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

     <footer class="footer">
        Â© 2024 Orphanage Management System | All Rights Reserved
    </footer>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let currentUserRole = null;
        let currentUserId = null;
        let assignedChildIds = [];


        function getLoggedInUser() {
            const userData = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
            if (!userData || !userData.role || !userData.id) {
                console.error("User not logged in or role/ID missing.");

                window.location.href = 'login.html';
                return null;
            }
            currentUserRole = userData.role;
            currentUserId = userData.id;
            return userData;
        }


        function setBackLink(role) {
            const backLink = document.getElementById('back-dashboard-link');
            if (role === 'Admin') {
                backLink.href = 'admin_dashboard.html';
            } else if (role === 'Staff') {
                backLink.href = 'staff_dashboard.html';
            } else {
                backLink.href = '../h.html';
            }
        }


        async function validateForm(event) {
            event.preventDefault();
            const childId = document.getElementById('child_id').value;
            const schoolName = document.getElementById('school_name').value.trim();
            const grade = document.getElementById('grade').value.trim();
            const performance = document.getElementById('performance').value.trim();
            const extracurricularActivities = document.getElementById('extracurricular_activities').value.trim();
            const attendance = document.getElementById('attendance').value.trim();
            const classValue = document.getElementById('class_section').value.trim();
            const recordId = document.getElementById('record_id').value;

            if (!childId || !schoolName || !grade || !classValue || !performance || !attendance || !extracurricularActivities) {
                 alert('Please fill in all required fields.'); return false;
             }

            const recordData = { child_id: childId, school_name: schoolName, grade, class: classValue, performance, extracurricular_activities: extracurricularActivities, attendance };
            const method = recordId ? 'PUT' : 'POST';
            const url = recordId ? `${API_BASE_URL}/api/educational-records/${recordId}` : `${API_BASE_URL}/api/educational-records`;
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true; submitButton.value = recordId ? 'Updating...' : 'Adding...';

            try {
                const response = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(recordData) });
                if (response.ok) {
                    alert(`Record ${recordId ? 'updated' : 'added'} successfully!`);
                    fetchEducationalRecords(); resetForm();
                } else {
                     let errorMsg = 'Unknown error.';
                     try { const err = await response.json(); errorMsg = err.message || JSON.stringify(err); } catch (e) { errorMsg = response.statusText; }
                     alert(`Error: ${errorMsg}`); console.error('Error:', errorMsg);
                 }
            } catch (error) { alert('Network error.'); console.error('Fetch error:', error); }
            finally { submitButton.disabled = false; submitButton.value = recordId ? 'Update Educational Record' : 'Add Educational Record'; }
        }


        async function populateChildDropdown() {
            const childSelect = document.getElementById('child_id');
            childSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

            try {
                let childrenToPopulate = [];
                if (currentUserRole === 'Admin') {

                    const response = await fetch(`${API_BASE_URL}/api/children`);
                    if (!response.ok) throw new Error('Failed to fetch children');
                    childrenToPopulate = await response.json();
                } else if (currentUserRole === 'Staff') {

                     if (assignedChildIds.length === 0) {
                         console.warn("No children assigned to this staff member.");



                         const response = await fetch(`${API_BASE_URL}/api/children`);
                         if (!response.ok) throw new Error('Failed to fetch children for staff');
                         const allChildren = await response.json();
                         childrenToPopulate = allChildren.filter(child => assignedChildIds.includes(child._id));

                     } else {



                           const response = await fetch(`${API_BASE_URL}/api/children`);
                           if (!response.ok) throw new Error('Failed to fetch children for staff');
                           const allChildren = await response.json();
                           childrenToPopulate = allChildren.filter(child => assignedChildIds.includes(child._id));
                     }
                }


                childSelect.innerHTML = '<option value="" disabled selected>Select a Child</option>';
                if (childrenToPopulate && childrenToPopulate.length > 0) {
                    childrenToPopulate.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child._id;
                        option.textContent = `${child.first_name} ${child.last_name} (ID: ${child._id.slice(-6)})`;
                        childSelect.appendChild(option);
                    });
                } else {
                    childSelect.innerHTML = `<option value="" disabled selected>${currentUserRole === 'Staff' ? 'No assigned children found' : 'No children found'}</option>`;
                }

            } catch (error) {
                console.error('Error populating children dropdown:', error);
                childSelect.innerHTML = '<option value="" disabled selected>Error loading children</option>';
            }
        }


        async function fetchAssignedChildrenIds(staffId) {
            if (!staffId) return [];
            try {

                const response = await fetch(`${API_BASE_URL}/api/staff-assignments`);
                if (!response.ok) throw new Error('Failed to fetch assignments');
                const allAssignments = await response.json();
                assignedChildIds = allAssignments
                                    .filter(a => a.staff_id && (a.staff_id._id === staffId || a.staff_id === staffId))
                                    .map(a => a.child_id ? (a.child_id._id || a.child_id) : null)
                                    .filter(id => id != null);
                console.log("Assigned Child IDs for Staff:", assignedChildIds);
                return assignedChildIds;
            } catch (error) {
                console.error('Error fetching staff assignments:', error);
                return [];
            }
        }



        async function fetchEducationalRecords() {
            const tableBody = document.getElementById('record-table-body');
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Loading records... <i class="fas fa-spinner fa-spin"></i></td></tr>`;

            try {
                const response = await fetch(`${API_BASE_URL}/api/educational-records`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                let records = await response.json();


                if (currentUserRole === 'Staff') {
                     if(assignedChildIds.length === 0) {
                        console.log("Staff has no assigned children, showing no records.");
                        records = [];
                     } else {
                        records = records.filter(record => {
                            const childId = record.child_id ? (record.child_id._id || record.child_id) : null;
                            return childId && assignedChildIds.includes(childId);
                        });
                     }

                     document.getElementById('record-list-title').textContent = 'Educational Records for Assigned Children';
                }

                renderEducationalRecords(records);

            } catch (error) {
                console.error('Error fetching educational records:', error);
                 tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: red;">Failed to load records. Please try again later.</td></tr>`;
            }
        }


        function renderEducationalRecords(records) {
            const tableBody = document.getElementById('record-table-body');
            tableBody.innerHTML = '';

            if (!records || records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">${currentUserRole === 'Staff' ? 'No records found for assigned children.' : 'No educational records found.'}</td></tr>`;
                return;
            }

             const escapeAttr = (str) => str ? String(str).replace(/'/g, "\\'").replace(/"/g, "") : '';

            records.forEach(record => {
                const row = document.createElement('tr');
                let childName = 'N/A'; let childIdForEdit = '';
                if (record.child_id && typeof record.child_id === 'object') { childName = `${record.child_id.first_name || ''} ${record.child_id.last_name || ''}`.trim() || 'Unknown'; childIdForEdit = record.child_id._id; }
                else if (record.child_id) { childName = `Child ID: ${record.child_id}`; childIdForEdit = record.child_id; }

                row.innerHTML = `
                    <td data-label="Child Name">${escapeAttr(childName)}</td>
                    <td data-label="School">${escapeAttr(record.school_name)}</td>
                    <td data-label="Grade">${escapeAttr(record.grade)}</td>
                    <td data-label="Class">${escapeAttr(record.class)}</td>
                    <td data-label="Performance Summary"><textarea readonly>${escapeAttr(record.performance)}</textarea></td>
                    <td data-label="Activities"><textarea readonly>${escapeAttr(record.extracurricular_activities)}</textarea></td>
                    <td data-label="Attendance"><textarea readonly>${escapeAttr(record.attendance)}</textarea></td>
                    <td data-label="Actions" class="actions-col">
                        <div class="action-buttons">
                            <button class="edit-button" onclick="editRecord('${escapeAttr(record._id)}', '${escapeAttr(childIdForEdit)}', '${escapeAttr(record.school_name)}', '${escapeAttr(record.grade)}', '${escapeAttr(record.class)}', '${escapeAttr(record.performance)}', '${escapeAttr(record.extracurricular_activities)}', '${escapeAttr(record.attendance)}')" title="Edit Record"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-button" onclick="deleteRecord('${escapeAttr(record._id)}')" title="Delete Record"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        async function deleteRecord(id) {
             if (!confirm(`Are you sure you want to delete record ID: ${id}?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/educational-records/${id}`, { method: 'DELETE' });
                 if (response.ok) { alert('Record deleted!'); fetchEducationalRecords(); }
                 else { throw new Error('Failed to delete'); }
            } catch (error) { console.error('Delete error:', error); alert('Error deleting record.'); }
        }


         function editRecord(recordId, childId, schoolName, grade, classVal, performance, activities, attendance) {
            document.getElementById('form-title').innerText = 'Edit Educational Record';
            document.getElementById('record_id').value = recordId;
            document.getElementById('child_id').value = childId;
            document.getElementById('school_name').value = schoolName;
            document.getElementById('grade').value = grade;
            document.getElementById('class_section').value = classVal;
            document.getElementById('performance').value = performance;
            document.getElementById('extracurricular_activities').value = activities;
            document.getElementById('attendance').value = attendance;
            document.getElementById('submit-button').value = 'Update Educational Record';
            document.getElementById('form-title').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }


        function resetForm() {
            document.getElementById('form-title').innerText = 'Add New Educational Record';
            document.getElementById('record-form').reset();
            document.getElementById('record_id').value = '';
            document.getElementById('submit-button').value = 'Add Educational Record';
            document.getElementById('submit-button').disabled = false;
        }


        window.onload = async () => {
            const user = getLoggedInUser();
            if (!user) return;

             setBackLink(user.role);

            if (user.role === 'Staff') {
                 await fetchAssignedChildrenIds(user.id);
             }

             await populateChildDropdown();
             await fetchEducationalRecords();
        };
    </script>
</body>
</html>