<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/styles.css"> 

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <title>Staff Dashboard - Orphanage Management System</title>
    <style>

        :root {
            --primary-color: #4a90e2;
            --primary-dark: #357ABD;
            --secondary-color: #50E3C2;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #343a40;
            --card-bg: #ffffff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --alert-padding-y: .75rem;
            --alert-padding-x: 1.25rem;
            --alert-margin-bottom: 1rem;
            --alert-border-radius: .25rem;
            --alert-border-width: 1px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            background: url('../img/11.png');
            background-size: cover;
            color: var(--text-color);
            line-height: 1.6;
            padding-top: 80px;
            font-size: 16px;
        }


        .staff-navbar {
             width: 100%;
             background-color: var(--primary-color);
             position: fixed;
             top: 0;
             left: 0;
             z-index: 1000;
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 15px 40px;
             box-shadow: var(--shadow-sm);
        }
        .staff-navbar .brand { color: #fff; font-size: 1.4em; font-weight: 600; }
        .staff-navbar .nav-links a { color: #fff; text-decoration: none; padding: 8px 16px; margin-left: 15px; border-radius: 5px; transition: background-color 0.2s ease; font-size: 0.95em; font-weight: 500; }
        .staff-navbar .nav-links a:hover { background-color: var(--primary-dark); }
        .staff-navbar .logout-link { background-color: var(--danger-color); }
        .staff-navbar .logout-link:hover { background-color: #c82333; }
        .staff-navbar .logout-link i { margin-right: 6px; }


        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
        }


        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
             box-shadow: var(--shadow-md);
        }
        .card.full-width {
            grid-column: 1 / -1;
        }
        .card-header {
            background-color: #f7f7f7;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.15em;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
        }
         .card-header i {
             margin-right: 10px;
             color: var(--primary-color);
         }
        .card-body {
            padding: 25px;
            flex-grow: 1;
        }


        .welcome-header {
             grid-column: 1 / -1;
             background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
             color: white;
             padding: 25px 40px;
             border-radius: 8px;
             margin-bottom: 10px;
             font-size: 1.6em;
             font-weight: 300;
             box-shadow: var(--shadow-md);
        }
        .welcome-header span { font-weight: 600; }


        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }
        select, input[type="file"], input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 18px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            background-color: #fff;
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25);
        }
        button, .button-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 0.95em;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
        }
         button:hover, .button-link:hover {
             opacity: 0.9;
             transform: translateY(-2px);
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }
        button:active, .button-link:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-secondary { background-color: var(--dark-gray); color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }

        button i, .button-link i { margin-right: 8px; }


        #child-profile-display {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--medium-gray);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #child-profile-display.visible {
            opacity: 1;
        }
        #child-profile-details {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 30px;
        }
        #child-photo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            object-fit: cover;
            background-color: var(--medium-gray);
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }
        #child-info { flex: 1; min-width: 280px; }
        #child-info h4 { margin-bottom: 15px; color: var(--primary-dark); font-weight: 600; font-size: 1.1em; }
        #child-info p { margin-bottom: 10px; font-size: 1em; color: #555; }
        #child-info p strong { font-weight: 600; color: var(--text-color); display: inline-block; width: 140px; }


        #child-documents-section { margin-top: 25px; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #child-documents-section.visible { opacity: 1; }
        #child-documents-section h4 { font-weight: 600; margin-bottom: 15px; color: var(--primary-dark); display: flex; align-items: center; font-size: 1.1em;}
        #child-documents-section h4 i { margin-right: 8px; color: var(--primary-color); }

        #child-document-list { list-style: none; padding: 0; margin-bottom: 25px; max-height: 220px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; background-color: #fff;}
        #child-document-list li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #child-document-list li:last-child { border-bottom: none; }
        #child-document-list li:hover { background-color: var(--light-gray); }
        #child-document-list li a { text-decoration: none; color: var(--primary-color); font-weight: 500; display: flex; align-items: center; }
        #child-document-list li a:hover { text-decoration: underline; }
        #child-document-list li a i { margin-right: 8px; }
        #child-document-list li span.date { font-size: 0.85em; color: var(--dark-gray); font-style: italic; }
        #child-document-list li.empty { color: var(--dark-gray); font-style: italic; text-align: center; padding: 25px; border: none; }
        #child-document-list li.loading { color: var(--dark-gray); font-style: italic; text-align: center; padding: 25px; border: none; }


        #upload-document-form button { margin-top: 10px; }
        #upload-status { margin-top: 15px; font-size: 0.9em; font-weight: 500; padding: 8px; border-radius: 4px; text-align: center;}
        #upload-status.success { color: var(--success-color); background-color: #e9f7ef; border: 1px solid #a6d7b7;}
        #upload-status.error { color: var(--danger-color); background-color: #fdeded; border: 1px solid #f1b0b7;}
        #upload-status.uploading { color: var(--primary-dark); background-color: #e7f3fe; border: 1px solid #a4cafe;}


        #my-schedule-display {
             margin-top: 15px;
             padding: 15px;
             border: 1px solid var(--border-color);
             border-radius: 5px;
             background-color: #fff;
             min-height: 60px;
             font-size: 0.95em;
             max-height: 280px; overflow-y: auto;
             color: #555;
         }
         #my-schedule-display ul { list-style: none; padding: 0; }
         #my-schedule-display li { padding: 8px 5px; border-bottom: 1px dashed var(--medium-gray); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
         #my-schedule-display li:last-child { border-bottom: none; }
         #my-schedule-display li strong { color: var(--primary-dark); }
         #my-schedule-display li .task-info { flex-grow: 1; }
         #my-schedule-display li .status-pending { color: var(--warning-color); font-weight: bold; }
         #my-schedule-display li .status-completed { color: var(--success-color); font-weight: bold; }


        #my-schedule-status {
            padding: var(--alert-padding-y) var(--alert-padding-x);
            margin-bottom: var(--alert-margin-bottom);
            border: var(--alert-border-width) solid transparent;
            border-radius: var(--alert-border-radius);
            display: none;
            margin-top: 15px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
        }
        #my-schedule-status i { margin-right: 6px;}
        #my-schedule-status.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        #my-schedule-status.error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        #my-schedule-status.loading { color: #004085; background-color: #cce5ff; border-color: #b8daff; }
        #my-schedule-status.info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }



        .hidden { display: none !important; }
        .visible { opacity: 1 !important; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-danger { color: var(--danger-color); }
        .text-muted { color: var(--dark-gray); }


        .fa-spinner {
            animation: fa-spin 1s infinite linear;
        }
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    
     <div class="staff-navbar">
        <div class="brand"><i class="fas fa-shield-alt"></i> Staff Portal</div>
        <div class="nav-links">
             <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    
    <div class="dashboard-container">

        
        <div class="welcome-header">
            Welcome, <span id="staff-username">Staff Member</span>!
        </div>

        
        <div class="card full-width" id="assigned-children-card">
            <div class="card-header">
                <i class="fas fa-child-reaching"></i> Manage Assigned Children
            </div>
            <div class="card-body">
                <label for="assigned-child-select">Select Child:</label>
                <select id="assigned-child-select" name="assigned_child_select">
                    <option value="">-- Select an Assigned Child --</option>
                    
                </select>

                
                <div id="child-profile-display" class="hidden">
                    <div id="child-profile-details">
                        <img id="child-photo" src="../img/placeholder_child.png" alt="Child Photo">
                        <div id="child-info">
                            <h4>Profile Overview</h4>
                            <p><strong>Name:</strong> <span id="child-name">N/A</span></p>
                            <p><strong>Date of Birth:</strong> <span id="child-dob">N/A</span></p>
                            <p><strong>Gender:</strong> <span id="child-gender">N/A</span></p>
                            <p><strong>Admission Date:</strong> <span id="child-admission">N/A</span></p>
                            
                        </div>
                    </div>
                 </div>

                
                <div id="child-documents-section" class="hidden">
                    <hr style="margin: 30px 0; border-top: 1px solid var(--medium-gray);">
                    <h4><i class="fas fa-folder-open"></i> Child Documents</h4>
                    <ul id="child-document-list">
                        <li class="loading" style="display:none;">Loading...</li> 
                        <li class="empty" style="display:none;">No documents found.</li> 
                    </ul>

                    <h4 class="mt-2"><i class="fas fa-upload"></i> Upload New Document</h4>
                    <form id="upload-document-form" onsubmit="handleDocumentUpload(event)">
                         <input type="hidden" id="upload-child-id" name="child_id">
                        <label for="document-file">Select file:</label>
                        <input type="file" id="document-file" name="documentFile" required>
                        <button type="submit" class="btn-success"><i class="fas fa-cloud-upload-alt"></i> Upload Document</button>
                        <div id="upload-status" class="mt-1"></div> 
                    </form>
                </div>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-notes-medical"></i> Health Records
            </div>
            <div class="card-body">
                 <p style="font-size: 0.9em; color: var(--dark-gray); margin-bottom: 15px;">Record, view, or update medical history for children.</p>
                 
                <a href="health_records.html" class="button-link btn-primary"><i class="fas fa-file-medical"></i> Manage Medical Records</a>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user-graduate"></i> Educational Records
            </div>
            <div class="card-body">
                 <p style="font-size: 0.9em; color: var(--dark-gray); margin-bottom: 15px;">Record, view, or update educational progress.</p>
                 
                <a href="educational_management.html" class="button-link btn-primary"><i class="fas fa-book-open-reader"></i> Manage Educational Records</a>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-envelope"></i> Communication
            </div>
            <div class="card-body">
                 <p style="font-size: 0.9em; color: var(--dark-gray); margin-bottom: 15px;">Send messages to other users and view messages sent to you.</p>
                 
                 <a href="messages.html" class="button-link btn-primary"><i class="fas fa-paper-plane"></i> View/Send Messages</a>
            </div>
        </div>

        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt"></i> My Schedule
            </div>
            <div class="card-body">
                 <p style="font-size: 0.9em; color: var(--dark-gray); margin-bottom: 15px;">View tasks assigned to you by the administration.</p>
                 
                 <button id="view-my-schedule-button" class="btn-warning">
                     <i class="fas fa-eye"></i> View My Schedule
                 </button>
                 
                 <div id="my-schedule-display" class="mt-2">
                    
                     <p>Click "View My Schedule" to load your assigned tasks.</p>
                 </div>
                 
                 <div id="my-schedule-status"></div>
            </div>
        </div>

    </div> 


    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const DEFAULT_CHILD_PHOTO = '../img/placeholder_child.png';
        let selectedChildId = null;
        let currentStaffId = null;


        window.addEventListener('DOMContentLoaded', () => {

            const storedStaff = JSON.parse(localStorage.getItem('loggedInStaff') || '{}');
            currentStaffId = storedStaff.id || null;
            const staffUsername = storedStaff.username || 'Staff Member';
            document.getElementById('staff-username').textContent = staffUsername;

            if (!currentStaffId) {
                console.error("Staff ID not found. Cannot fetch assigned data.");
                alert("Could not identify staff member. Please log in again.");

                document.getElementById('assigned-child-select').disabled = true;
                const viewScheduleButton = document.getElementById('view-my-schedule-button');
                 if (viewScheduleButton) viewScheduleButton.disabled = true;
                return;
            }

            fetchAssignedChildren(currentStaffId);
            setupEventListeners();
        });



        function getLoggedInUserId() {

            const storedUser = JSON.parse(localStorage.getItem('loggedInStaff') || '{}');

            currentStaffId = storedUser.id || null;
            return currentStaffId;
        }


        function getAuthHeaders() {
            const userId = getLoggedInUserId();
            if (!userId) {
                console.error("Cannot create auth headers: User ID is missing.");
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'X-User-ID': userId
            };
        }


        function setupEventListeners() {

            const childSelect = document.getElementById('assigned-child-select');
            if (childSelect) {
                 childSelect.addEventListener('change', handleChildSelection);
            }


            const uploadForm = document.getElementById('upload-document-form');
             if (uploadForm) {
                 uploadForm.addEventListener('submit', handleDocumentUpload);
             }


            const viewScheduleButton = document.getElementById('view-my-schedule-button');
            if (viewScheduleButton) {
                viewScheduleButton.addEventListener('click', fetchMySchedule);
            } else {
                 console.error("Button 'view-my-schedule-button' not found.");
            }


            const scheduleDisplay = document.getElementById('my-schedule-display');
            if (scheduleDisplay) {
                scheduleDisplay.addEventListener('click', handleMarkCompleteClick);
            }
        }



        async function fetchMySchedule() {
            const scheduleDisplay = document.getElementById('my-schedule-display');
            const statusDiv = document.getElementById('my-schedule-status');

            displayScheduleStatus("Loading your schedule...", "loading", false);
            scheduleDisplay.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading...</p>';

            const headers = getAuthHeaders();
            if (!headers) {
                displayScheduleStatus("Authentication error. Cannot fetch schedule.", "error", false);
                scheduleDisplay.innerHTML = '<p class="text-danger">Authentication error.</p>';
                return;
            }

            try {

                const response = await fetch(`${API_BASE_URL}/api/my-schedule`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error("Authentication failed. Please log in again.");
                    }
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Error fetching schedule (${response.status})`);
                }

                const tasks = await response.json();
                renderMySchedule(tasks);
                displayScheduleStatus("", "info", false);

            } catch (error) {
                console.error('Error fetching your schedule:', error);
                renderMySchedule([]);
                displayScheduleStatus(`Error: ${error.message}`, 'error', false);
                scheduleDisplay.innerHTML = `<p class="text-danger">Could not load schedule: ${error.message}</p>`;
            }
        }

        function renderMySchedule(tasks) {
            const scheduleDisplay = document.getElementById('my-schedule-display');
            scheduleDisplay.innerHTML = '';

             if (!tasks || tasks.length === 0) {
                scheduleDisplay.innerHTML = '<p>You have no tasks assigned currently.</p>';
            } else {
                let html = '<ul>';
                tasks.forEach(task => {
                    const isPending = task.status !== 'completed';
                    const dueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'None';
                    const completedDateStr = task.dateCompleted ? new Date(task.dateCompleted).toLocaleDateString() : '-';
                    const statusClass = `status-${task.status || 'pending'}`;
                    const statusText = task.status || 'pending';

                    html += `<li>
                        <div class="task-info">
                             <strong>Task:</strong> ${task.taskDescription || 'N/A'} <br>
                             <small>Due: ${dueDateStr} | Status: <span class="${statusClass}">${statusText}</span> ${statusText === 'completed' ? `(Completed: ${completedDateStr})` : ''}</small>
                        </div>
                        ${isPending ?
                            `<button class="btn-sm btn-success btn-mark-complete" data-task-id="${task._id}" title="Mark as Completed">
                               <i class="fas fa-check"></i> Mark Complete
                            </button>` :
                            ''
                        }
                    </li>`;
                });
                html += '</ul>';
                scheduleDisplay.innerHTML = html;
            }
        }

        async function handleMarkCompleteClick(event) {
             if (event.target.closest('.btn-mark-complete')) {
                 const button = event.target.closest('.btn-mark-complete');
                 const taskId = button.dataset.taskId;
                 if (!taskId) return;

                 if (!confirm("Are you sure you want to mark this task as complete?")) {
                      return;
                 }

                 button.disabled = true;
                 button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                 displayScheduleStatus("Marking task as complete...", "loading", false);

                 const headers = getAuthHeaders();
                 if (!headers) {
                     displayScheduleStatus("Authentication error.", "error", false);
                     button.disabled = false;
                     button.innerHTML = '<i class="fas fa-check"></i> Mark Complete';
                     return;
                 }

                 try {

                     const response = await fetch(`${API_BASE_URL}/api/schedule/${taskId}/complete`, {
                         method: 'PATCH',
                         headers: headers
                     });

                     if (!response.ok) {
                         const errorData = await response.json().catch(() => ({}));
                         throw new Error(errorData.message || `Failed to mark complete (${response.status})`);
                     }

                     displayScheduleStatus("Task marked as complete!", "success", true);
                     fetchMySchedule();

                 } catch (error) {
                     console.error("Error marking task complete:", error);
                     displayScheduleStatus(`Error: ${error.message}`, "error", false);
                     button.disabled = false;
                     button.innerHTML = '<i class="fas fa-check"></i> Mark Complete';
                 }
             }
         }


        async function fetchAssignedChildren(staffId) {
            const selectElement = document.getElementById('assigned-child-select');
            selectElement.innerHTML = '<option value="">-- Loading... --</option>';
            selectElement.disabled = true;
            try {


                const response = await fetch(`${API_BASE_URL}/api/staff-assignments?staff_id=${staffId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const assignments = await response.json();

                selectElement.innerHTML = '<option value="">-- Select an Assigned Child --</option>';
                if (assignments.length === 0) {
                    selectElement.innerHTML = '<option value="">-- No Children Assigned --</option>';
                    return;
                }
                assignments.forEach(assignment => {
                    if (assignment.child_id && assignment.child_id._id) {
                        const option = document.createElement('option');
                        option.value = assignment.child_id._id;
                        option.textContent = `${assignment.child_id.first_name || ''} ${assignment.child_id.last_name || ''}`;
                        selectElement.appendChild(option);
                    }
                });
                selectElement.disabled = false;
            } catch (error) {
                console.error('Error fetching assigned children:', error);
                selectElement.innerHTML = '<option value="">-- Error Loading Children --</option>';


            }
        }

        async function fetchChildProfile(childId) {
            const profileDisplay = document.getElementById('child-profile-display');
            const photoElement = document.getElementById('child-photo');
            const infoContainer = document.getElementById('child-info');

            infoContainer.innerHTML = `<h4>Profile Overview</h4><p>Loading...</p>`;
            photoElement.src = DEFAULT_CHILD_PHOTO;
            profileDisplay.classList.remove('visible');
            profileDisplay.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/children/${childId}`);
                if (!response.ok) throw new Error(`Profile fetch failed: ${response.statusText}`);
                const child = await response.json();

                infoContainer.innerHTML = `<h4>Profile Overview</h4>
                                           <p><strong>Name:</strong> <span id="child-name">${child.first_name || ''} ${child.last_name || ''}</span></p>
                                           <p><strong>Date of Birth:</strong> <span id="child-dob">${child.date_of_birth ? new Date(child.date_of_birth).toLocaleDateString() : 'N/A'}</span></p>
                                           <p><strong>Gender:</strong> <span id="child-gender">${child.gender || 'N/A'}</span></p>
                                           <p><strong>Admission Date:</strong> <span id="child-admission">${child.admission_date ? new Date(child.admission_date).toLocaleDateString() : 'N/A'}</span></p>`;
                photoElement.src = child.photo_url ? `${API_BASE_URL}${child.photo_url}` : DEFAULT_CHILD_PHOTO;
                photoElement.onerror = () => { photoElement.src = DEFAULT_CHILD_PHOTO; };
                profileDisplay.classList.add('visible');
            } catch (error) {
                console.error(`Error fetching profile for child ${childId}:`, error);
                infoContainer.innerHTML = `<p class="text-danger">Could not load profile details.</p>`;
                profileDisplay.classList.add('visible');
            }
        }

        async function fetchChildDocuments(childId) {
            const listElement = document.getElementById('child-document-list');
            const documentsSection = document.getElementById('child-documents-section');
            listElement.innerHTML = '<li class="loading"><i class="fas fa-spinner fa-spin"></i> Loading documents...</li>';
            documentsSection.classList.remove('visible');
            documentsSection.classList.remove('hidden');

            try {

                const response = await fetch(`${API_BASE_URL}/api/children/${childId}/documents`);
                if (!response.ok) throw new Error(`Document fetch failed: ${response.statusText}`);
                const documents = await response.json();
                listElement.innerHTML = '';
                if (documents.length === 0) {
                    listElement.innerHTML = '<li class="empty">No documents uploaded yet.</li>';
                } else {
                    documents.forEach(doc => {
                        const li = document.createElement('li');

                        const downloadUrl = `${API_BASE_URL}/api/documents/${doc._id}/download`;
                        const displayFilename = doc.filename || 'Document';
                        li.innerHTML = `
                            <a href="${downloadUrl}" target="_blank" title="Download ${displayFilename}">
                                <i class="fas fa-file-alt"></i> ${displayFilename}
                            </a>
                            <span class="date">(Uploaded: ${doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString() : 'N/A'})</span>`;
                        listElement.appendChild(li);
                    });
                }
                documentsSection.classList.add('visible');
            } catch (error) {
                console.error(`Error fetching documents for child ${childId}:`, error);
                listElement.innerHTML = `<li class="empty text-danger">Could not load documents.</li>`;
                documentsSection.classList.add('visible');
            }
        }

        function handleChildSelection(event) {
            selectedChildId = event.target.value;
            const profileDisplay = document.getElementById('child-profile-display');
            const documentsSection = document.getElementById('child-documents-section');
            const uploadChildIdInput = document.getElementById('upload-child-id');

            profileDisplay.classList.remove('visible');
            profileDisplay.classList.add('hidden');
            documentsSection.classList.remove('visible');
            documentsSection.classList.add('hidden');
            uploadChildIdInput.value = '';

            if (selectedChildId) {
                uploadChildIdInput.value = selectedChildId;
                fetchChildProfile(selectedChildId);
                fetchChildDocuments(selectedChildId);
            }
        }

        async function handleDocumentUpload(event) {
            event.preventDefault();
            const form = event.target;
            const fileInput = document.getElementById('document-file');
            const childId = document.getElementById('upload-child-id').value;
            const uploadStatus = document.getElementById('upload-status');

            uploadStatus.textContent = '';
            uploadStatus.className = 'mt-1';

            if (!childId) { uploadStatus.textContent = 'Please select a child.'; uploadStatus.className = 'mt-1 error'; return; }
            if (!fileInput.files || fileInput.files.length === 0) { uploadStatus.textContent = 'Please select a file.'; uploadStatus.className = 'mt-1 error'; return; }

            const formData = new FormData();
            formData.append('documentFile', fileInput.files[0]);

            uploadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadStatus.className = 'mt-1 uploading';

            try {

                const response = await fetch(`${API_BASE_URL}/api/children/${childId}/documents`, {
                    method: 'POST',
                    body: formData,
                    headers: { }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Upload failed (${response.status})` }));
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }

                uploadStatus.textContent = 'Upload successful!';
                uploadStatus.className = 'mt-1 success';
                form.reset();
                document.getElementById('upload-child-id').value = childId;
                fetchChildDocuments(childId);

                setTimeout(() => { if (uploadStatus.classList.contains('success')) { uploadStatus.textContent = ''; uploadStatus.className = 'mt-1'; } }, 4000);

            } catch (error) {
                 console.error('Error uploading document:', error);
                 uploadStatus.textContent = `Upload error: ${error.message}`;
                 uploadStatus.className = 'mt-1 error';
             }
        }


        function displayScheduleStatus(message, type = 'info', autoHide = true) {
             const statusDiv = document.getElementById('my-schedule-status');
             if (!statusDiv) { console.warn("Status div 'my-schedule-status' not found."); return; }

             statusDiv.className = type;
             let iconClass = 'fas fa-info-circle';
             if (type === 'success') { statusDiv.className = 'mt-1 success'; iconClass = 'fas fa-check-circle'; }
             if (type === 'error') { statusDiv.className = 'mt-1 error'; iconClass = 'fas fa-exclamation-triangle'; }
             if (type === 'loading') { statusDiv.className = 'mt-1 loading'; iconClass = 'fas fa-spinner fa-spin'; }
             if (type === 'info') { statusDiv.className = 'mt-1 info'; }

             statusDiv.innerHTML = message ? `<i class="${iconClass}"></i> ${message}` : '';
             statusDiv.style.display = message ? 'block' : 'none';

             if (autoHide && (type === 'success' || type === 'info')) {
                 setTimeout(() => {
                     if (statusDiv.innerHTML.includes(message)) {
                         statusDiv.style.display = 'none';
                         statusDiv.textContent = '';
                         statusDiv.className = 'mt-1';
                     }
                 }, 4000);
             }
         }

        function logout() {
            localStorage.removeItem('loggedInStaff');
            alert("You have been logged out.");
            window.location.href = "login.html";
        }

    </script>

</body>
</html>